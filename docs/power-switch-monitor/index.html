<!DOCTYPE html>
<html lang="en-US" itemscope itemtype="http://schema.org/Blog" prefix="og: http://ogp.me/ns#">
<head>
    <meta charset="UTF-8">
    <title>Power Switch Monitor with an Arduino device</title>
    <base href="https://docodethatmatters.com">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta itemprop="description" content="Automate smart devices using an existing light switch and power switch monitor with an Arduino compatible device with wifi." />
    <meta name="description" content="Automate smart devices using an existing light switch and power switch monitor with an Arduino compatible device with wifi." />
    <meta name="keywords" content="arduino,wemos,home automation,node red,bme280,smart home,smart light" />
    <meta name="Distribution" content="Global" />
    <meta name="Rating" content="General" />
    <meta name="Robots" content="INDEX,FOLLOW" />
    <meta name="author" content="Do Code That Matters" />
    <meta name="Revisit-after" content="31 Days" />
    <meta name="application-name" content="Do Code That Matters">
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Power Switch Monitor with an Arduino device - Do Code That Matters" />
    <meta property="og:title" content="Power Switch Monitor with an Arduino device - Do Code That Matters" />
    <meta property="og:description" content="Automate smart devices using an existing light switch and power switch monitor with an Arduino compatible device with wifi." />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://docodethatmatters.com" />
    <meta property="og:site_name" content="Do Code That Matters" />
    <meta name="twitter:description" content="Automate smart devices using an existing light switch and power switch monitor with an Arduino compatible device with wifi." />
    <meta name="twitter:creator" content="@skittleson" />
    <meta property="og:image" content="/images/powerMonitorFlowSetup.png" />
    <link href="/site.css" rel="stylesheet">
    <link rel='manifest' href='/manifest.json'>
    <link type="application/rss+xml" rel="alternate" title="Do Code That Matters - Spencer Kittleson" href="https://docodethatmatters.com/rss.xml" />
    <link type="application/feed+json" rel="alternate" title="Do Code That Matters - Spencer Kittleson" href="https://docodethatmatters.com/feed.json" />
    <link type="text/plain" rel="author" href="https://DoCodeThatMatters.com/humans.txt" />
    <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inconsolata&display=swap"
      rel="stylesheet"
    />

<body class="dark">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar dark border-bottom">
        <div class="container">
            <a href="/" class="navbar-brand d-flex align-items-center logo">
                <img class="logo-img" src="images/logoWhiteTrans.png" alt="Do Code That Matters" width="60" height="19" />Do Code That Matters</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
<li class="nav-item">
    <a class="nav-link" href="/blog">Blog</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/about">About</a>
</li>
                </ul>
            </div>
        </div>
    </nav><main class="container article">
  <div class="row">
    <article class="col-lg-12" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      <header>
        <meta itemprop="mainEntityOfPage" content="https://DoCodeThatMatters.com/power-switch-monitor">
        <h1 itemprop="name headline">Power Switch Monitor with an Arduino device</h1>
        <small>
          <time itemprop="datePublished" datetime="2020-06-01T00:00:00.000Z">Jun 01 2020</time>
          by
          <span itemprop="author" itemscope itemtype="https://schema.org/Person">
            <a rel="author" itemprop="url" href="https://DoCodeThatMatters.com/about" title="View author biography">
              <span itemprop="name">Spencer Kittleson</span>
            </a>
            <meta itemprop="jobTitle" content="Software Engineer">
          </span>
          <span itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
            <meta itemprop="name" content="Do Code That Matters">
            <span itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
              <meta itemprop="url" content="https://DoCodeThatMatters.com/images/agile.jpg">
            </span>
          </span>
        </small>
        <br />
        <figure itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
          <img itemprop="url contentUrl" alt="power switch monitor flow" src="/images/powerMonitorFlowSetup.png">
          <figcaption itemprop="caption">power switch monitor flow</figcaption>
        </figure>
        <br />
      </header>
      <section itemprop="articleBody" class="article-body">
        <p>The biggest rule for home automation is not to change existing behavior of users that causes inconvenience or frustration. Which is a rule that easily forgotten. Let's use the classic example of a smart light bulb in a living room. A user typically flips a switch to turn on and off a light. Now they have to ask Alexa, Google, or use an app on their phone. <strong>This is bad.</strong></p>
<p><img loading="lazy" src="https://media.giphy.com/media/1M9fmo1WAFVK0/source.gif" alt="" /></p>
<p>It's causing an inconvenience because the user can't flip a switch.</p>
<h2 id="solutions">Solutions</h2>
<p>The 2 common solutions presented in this situation:</p>
<p><strong>1. Blocking the user</strong> with tape or other mechanism. Checkout Thingiverse to see how common this is: <a href="https://www.thingiverse.com/tag:Light_Switch_Cover">https://www.thingiverse.com/tag:Light_Switch_Cover</a>. This changes user behavior so it's a bad idea.</p>
<p><strong>2. Replacing the light switch</strong> with a smarter one. This is the best option but requires a hardware replacement of the light switch. Which may not be possible, costly and potential dangerous to do-it-yourself!</p>
<p><strong>3. A third hybrid solution: Trigger the smart device with the existing light switch using power wall outlet as feedback</strong> using an Arduino device with WiFi. In this solution, the light switch changes the power state of the outlet that the Arduino based micro controller is monitoring. When the light switch is turn on/off it changes the power to the Arduino analog voltage GPIO pin. That sends a message off to a home assistance to notify the smart device. In US based homes, the 2nd wall outlet still has power so it provides constant power to the device. Here is a diagram to get an idea of the flow to toggle the smart bulb state from a user.</p>
<p><img loading="lazy" src="images/powerMonitorFlowSetup.png" alt="" /></p>
<p>The advantages:</p>
<ul>
<li>Simple &amp; low effort</li>
<li>Use existing switches to make them smart</li>
<li>Ability to control multiple devices with a single switch</li>
<li>Open source</li>
</ul>
<hr />
<h2 id="building-the-device">Building the Device</h2>
<h3 id="step-1-get-the-components-and-solder-them">Step 1: Get the Components and Solder Them</h3>
<h4 id="tools">Tools</h4>
<ul>
<li>Soldering iron</li>
<li>Third hand or vise</li>
</ul>
<h4 id="material">Material</h4>
<ul>
<li><a href="https://amzn.to/2zI2nUf">Wemos mini d1 from Amazon</a> or similar esp8266 / esp32 device</li>
<li>2 x resistors (any two usually works, i used 10k)</li>
<li>Wire</li>
<li>2 5v usb wall chargers.</li>
<li>1 male usb plugin</li>
<li>1 regular usb charging cable for the esp32.</li>
<li>led</li>
<li>solder</li>
<li>(optional) <a href="https://amzn.to/2U2qCTM">bme280</a> or <a href="https://amzn.to/2XL2C8U">bme680</a></li>
</ul>
<p><img loading="lazy" src="images/PowerMonitor_bb.png" alt="bread board version" /></p>
<p><img loading="lazy" src="images/PowerMonitor_schem.png" alt="schema version" /></p>
<p><img loading="lazy" src="images/PowerMonitorFront.jpg" alt="wemos mini d1 lite with bme680 front" /></p>
<p><img loading="lazy" src="images/PowerMonitorBack.jpg" alt="wemos mini d1 lite with bme680 back" /></p>
<h3 id="step-2-download-and-upload-software">Step 2: Download and Upload Software</h3>
<p>Flash your device with a <a href="https://tasmota.github.io/docs/">Tasmota</a> firmware.</p>
<h4 id="tasmota-module-configuration">Tasmota Module configuration</h4>
<p>Set to: <code>Generic Module</code> then click <code>Save</code>. the device will restart.</p>
<ul>
<li>D2 - I2C SDA (6) - BME680</li>
<li>D1 - I2C SCL (5) - BME680</li>
<li>A0 - Analog (1) - connected to 5V power supply resistor divider</li>
</ul>
<h4 id="tasmota-console">Tasmota Console</h4>
<p>Send when external light switch power is on, send <code>1</code>.</p>
<p><code>Rule1 ON analog#a0&gt;1000 DO Backlog Rule1 0; Rule2 1; Publish cmnd/masterlight/SWITCH 1 ENDON</code></p>
<p>When external light switch power is off, send <code>0</code>.</p>
<p><code>Rule2 ON analog#a0&lt;1000 DO Backlog Rule1 1; Rule2 0; Publish cmnd/masterlight/SWITCH 0 ENDON</code></p>
<p>Enable rule 1: <code>Rule1 1</code></p>
<p>Ensure you have MQTT enable then look at the console for messages similar to this:</p>
<pre><code class="language-bash">01:39:26 MQT: stat/tasmota_A61989/POWER1 = ON
01:39:26 RUL: POWER1#STATE=1 performs &quot;Backlog Delay 10; Power1 0&quot;
01:39:26 MQT: stat/tasmota_A61989/RESULT = {&quot;Delay&quot;:10}
01:39:26 RUL: SWITCH2#STATE performs &quot;Publish cmnd/garagedoor/SWITCH 0&quot;
01:39:26 MQT: cmnd/garagedoor/SWITCH = 0
01:39:26 MQT: stat/tasmota_A61989/RESULT = {&quot;POWER1&quot;:&quot;OFF&quot;}
01:39:26 MQT: stat/tasmota_A61989/POWER1 = OFF
1:40:11 MQT: tele/tasmota_A61989/STATE = {&quot;Time&quot;:&quot;2020-06-26T01:40:11&quot;,&quot;Uptime&quot;:&quot;6T03:00:30&quot;,&quot;UptimeSec&quot;:529230,&quot;Heap&quot;:23,&quot;SleepMode&quot;:&quot;Dynamic&quot;,&quot;Sleep&quot;:50,&quot;LoadAvg&quot;:19,&quot;MqttCount&quot;:1,&quot;POWER1&quot;:&quot;OFF&quot;,&quot;POWER2&quot;:&quot;OFF&quot;,&quot;Wifi&quot;:{&quot;AP&quot;:1,&quot;SSId&quot;:&quot;lucky&quot;,&quot;BSSId&quot;:&quot;4C:ED:FB:7B:4A:98&quot;,&quot;Channel&quot;:4,&quot;RSSI&quot;:100,&quot;Signal&quot;:-34,&quot;LinkCount&quot;:1,&quot;Downtime&quot;:&quot;0T00:00:05&quot;}}
01:40:11 MQT: tele/tasmota_A61989/SENSOR = {&quot;Time&quot;:&quot;2020-06-26T01:40:11&quot;,&quot;Switch2&quot;:&quot;OFF&quot;}
</code></pre>
<p>The MQTT topic is <code>cmnd/masterlight/SWITCH</code> with a boolean value of either <code>1</code> for open or <code>0</code> for close. The topics are for state or the reed switch sensor value <code>Switch2</code> that are sent every 5 minutes (configurable) via MQTT.</p>
<h3 id="step-3-add-to-a-home-assistance">Step 3: Add to a Home Assistance</h3>
<p>So here comes the part that could change per user preferences. I'm using NodeRed but this could be done with other home assistance software.  Get the MQTT message then process notifications you would like.</p>
<p><img loading="lazy" src="images/nodeRedPowerMonitor.png" alt="NodeRed power monitor setup" /></p>
<h2 id="resources">Resources</h2>
<p><a href="https://learn.adafruit.com/adafruit-bme680-humidity-temperature-barometic-pressure-voc-gas/arduino-wiring-test">https://learn.adafruit.com/adafruit-bme680-humidity-temperature-barometic-pressure-voc-gas/arduino-wiring-test</a>
<a href="https://www.bosch-sensortec.com/products/environmental-sensors/gas-sensors-bme680/">https://www.bosch-sensortec.com/products/environmental-sensors/gas-sensors-bme680/</a>
<a href="https://lastminuteengineers.com/bme280-arduino-tutorial/">https://lastminuteengineers.com/bme280-arduino-tutorial/</a></p>

      </section>
    </article>
  </div>


 See something inaccurate or need more detail? <a
        href="https://github.com/skittleson/DoCodeThatMatters/issues/new?title=Post%20-%20Power+Switch+Monitor+with+an+Arduino+device">Submit a Pull
        Request</a> to help me out!
      <br />
      <a href="https://www.buymeacoffee.com/skittles">Buy me a ☕ to support!</a>
<hr />

<h3>Latest Posts</h3>
  <ul class="unstyledUl">
    <li>
      <a class="read-more" href="hacking-sony-a6000-more">Part 2 of Hacking my Sony A6000 Camera</a>
    </li>
    <li>
      <a class="read-more" href="hacking-sony-a6000-for-modernization">Hacking my Sony A6000 Camera Adding Modern Features</a>
    </li>
    <li>
      <a class="read-more" href="linux-wifi-hotspot-usb3">Linux Wifi Hotspot with PiHole</a>
    </li>
    <li>
      <a class="read-more" href="onboarding-devs">Effective Onboarding for New Engineers</a>
    </li>
    <li>
      <a class="read-more" href="skateboard-gear">Parametric Belt Driven 3D Printed Spur Gear for Electric Skateboards</a>
    </li>
  </ul>

      
</main>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/agate.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/languages/csharp.min.js"></script>
<script>hljs.highlightAll();</script>
<script async src="/site.js"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-93963699-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-93963699-1');
</script>
</body>

</html>