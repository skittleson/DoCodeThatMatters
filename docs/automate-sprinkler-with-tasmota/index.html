<!DOCTYPE html>
<html lang="en-US" itemscope itemtype="http://schema.org/Blog" prefix="og: http://ogp.me/ns#">

<head>
    <title>Sprinklers, like programming on a VCR but worst!</title>
    <meta charset="utf-8">
    <base href="/">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta itemprop="description" name="description" content="" />
    <meta name="keywords" content="sprinkler,tasmota,bme280,mqtt,arduino,wemos,home automation,node red,pcb,alexa,maker" />
    <meta name="Distribution" content="Global" />
    <meta name="Rating" content="General" />
    <meta name="Robots" content="INDEX,FOLLOW" />
    <meta name="author" content="Do Code That Matters" />
    <meta name="Revisit-after" content="31 Days" />
    <meta name="application-name" content="Do Code That Matters">
    <meta property="og:title" content="Sprinklers, like programming on a VCR but worst! | Do Code That Matters" />
    <meta property="og:type" content="blog" />
    <meta property="og:description" content="" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Do Code That Matters" />
    <meta name="twitter:description" content="" />
    <link href="/css/site.css" rel="stylesheet">
    <link rel='manifest' href='/manifest.json'>
    <link rel="alternate" type="application/rss+xml" title="My Test Feed" href="https://DoCodeThatMatters.com/rss.xml" />
    <link type="text/plain" rel="author" href="https://DoCodeThatMatters.com/humans.txt" />
</head>

<body>

    <header class="navbar">
        <section class="navbar-section">
            <a href="/" class="navbar-brand mr-2">Do Code<div class='small-device'></div> That Matters</a>
            <a href="/blog" class="btn btn-link">Blog</a>
            <a href="/about" class="btn btn-link">About</a>        </section>
    </header><main class="postMain">
  <article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <meta itemprop="mainEntityOfPage" content="https://DoCodeThatMatters.com/automate-sprinkler-with-tasmota">
      <h1 itemprop="name headline">Sprinklers, like programming on a VCR but worst!</h1>
      <small>
        <time itemprop="datePublished" content="2020-11-02T00:00:00.000Z">1 November 2020</time>
        <meta itemprop="dateModified" content="2020-11-02T00:00:00.000Z">
        by
        <span itemprop="author" itemscope itemtype="https://schema.org/Person">
          <a rel="author" itemprop="url" href="https://DoCodeThatMatters.com/about" title="View author biography">
            <span itemprop="name">Spencer Kittleson</span>
          </a>
          <meta itemprop="jobTitle" content="Software Engineer">
        </span>
        <span itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
          <meta itemprop="name" content="Do Code That Matters">
          <span itemprop="logo" itemscope itemtype="https://schema.org/ImageObject">
            <meta itemprop="url" content="https://DoCodeThatMatters.com/images/agile.jpg">
          </span>
        </span>
      </small>
      <br />
      <figure itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
        <img itemprop="url contentUrl" alt="sprinkler running" src="images/sprinklerRunning.jpg">
        <figcaption itemprop="caption">sprinkler running</figcaption>
      </figure>
      <br />
    </header>
    <section itemprop="articleBody" class="article-body">
      <p>I'm frustrated on over-the-shelf sprinkler systems for home owners. They are complicated to use, outdated, and can't customize at a good price. The open source community has solved this!  The primary objective is to setup a water sprinkler to toggle based on special conditions like time (including sunrise/sunset), humidity, and perhaps temperature. So let's make it!</p>
<p><small>(there is affiliate links on this page for hardware used in this project)</small></p>
<p><img src="images/sprinklerRunning.jpg" alt="Sprinkler running"></p>
<h2>Build a Watering sprinkler for less, better and for low effort</h2>
<h3>Must Haves</h3>
<ul>
<li>‚úÖ IoT device runs when the internet is down (or network is down).</li>
<li>‚úÖ Timer based watering (support for sunrise/sunset as well)</li>
<li>‚úÖ Manual toggling watering state</li>
<li>‚úÖ Backup / Restore settings</li>
<li>üöß If sunrise/sunset with a temperature restriction then start watering. To prevent freezing</li>
</ul>
<h3>Wants</h3>
<ul>
<li>‚úÖ Measure water time, humidity, and temperature (All off-the-shelf sprinklers do this with various features)</li>
<li>‚úÖ Local network control with no data submitted to third party</li>
<li>‚úÖ graphing and ability to analyze the data</li>
<li>üöß Watering runaway protection</li>
<li>‚è≥ If humidity is at percentage then skip watering today (Most over-the-shelf sprinklers do this)</li>
<li>‚è≥ If weather forecast is rainy then skip watering. Notify me when this occurs. (Most off-the-shelf sprinklers can do this sort of)</li>
<li>‚è≥ Send to notification to any platform I want (AWS, Gmail, IFTTT, Alexa, etc... )</li>
<li>‚è≥ Moisture sensor</li>
</ul>
<h2>Research</h2>
<p>No over-the-shelf sprinkler system for a reasonable price can do ALL of this! How to do this for less, better, and low effort? The best solution is a mixed of inexpensive hardware and customizable open source software. Yes, there is some learning here but it's only the initial effort that can be a hurdle.</p>
<h3>Hardware</h3>
<p>At the lowest level, the IoT hardware should be the following:</p>
<ul>
<li>Toggle power on/off</li>
<li>Report power state, humidity, and temperature</li>
<li>Not require an internet connection.</li>
<li>Customize power toggling based on special conditions.</li>
</ul>
<p>$20 USD over-the-shelf Sonoff hardware that does those 3 out of 4 easily. The 4th point needs to have special programming.  There are multiple options out there but this fulfills the need of an &quot;over-the-shelf&quot; device that can be used with open source software.</p>
<p><a href="https://amzn.to/3jKFeT8"><img src="images/sonoff_temp.jpg" alt="Sonoff device"></a></p>
<p>The easiest way to wire this up is using an existing extension cord, cut into it, then follow the directions of wiring Sonoff guide.  Plug one into the power supply of an existing water sprinkler adapter.</p>
<p><a href="https://www.amazon.com/Reliapro-ADU240100D5531-Adapter-Transformer-Straight/dp/B00B8866E2/ref=as_li_ss_il?crid=1ZIS37DPUSEP9&dchild=1&keywords=sprinkler+transformer+24v&qid=1604364226&sprefix=sprinkler+tran,aps,294&sr=8-4&linkCode=li2&tag=dctm-20&linkId=c84c864b9723984df298c2d892724ab9&language=en_US" target="_blank"><img border="0" src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=B00B8866E2&Format=_SL160_&ID=AsinImage&MarketPlace=US&ServiceVersion=20070822&WS=1&tag=dctm-20&language=en_US" ></a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=dctm-20&language=en_US&l=li2&o=1&a=B00B8866E2" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>
<h3>Software</h3>
<p>The device can be flashed with open source software <a href="https://tasmota.github.io/docs/">Tasmota</a>.  I prototyped with the Arduino IDE for awhile but Tasmota seems safer with more features. So I won't go into too much detail but Tasmota  solves the following problems:</p>
<ul>
<li>Local network controlled</li>
<li>Runs even when the internet is down</li>
<li>Highly customizable and battle tested for years.</li>
<li>Simple programming</li>
<li>Multiple ways of interacting (command line, mqtt, web ui)</li>
</ul>
<p>Here is a video on how to flash and setup the device when you get it (this is really common with this device).</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/LwZltnda4v8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h3>Setup Time</h3>
<p>Using the Tasmota Web Console Command line</p>
<ul>
<li>Set your time zone using standard GMT offset: <code>Timezone -7</code> .</li>
<li>Test your time with <code>time</code></li>
<li>Update your location (use can use https://www.latlong.net/)
<ul>
<li>Run <code>Latitude 0.00</code> for latitude</li>
<li>Run <code>Longitude 0.00</code> for longitude</li>
</ul>
</li>
<li>Run <code>STATUS 7</code> to see sunrise / sunset with local time</li>
</ul>
<h3>Setup Timers</h3>
<p>Using the Tasmota Timer Web UI, 4 timers will be created. Two timers for starting/stopping the watering at sunrise. Two timers for same at sunset.</p>
<p>‚ùì Why use the Web UI when Tasmota can do this via command line?</p>
<p>‚≠ê Makes it easily adjustable in Web UI vs using the Tasmota command line.</p>
<p>Setup a sunrise starting timer for to run for 15 minutes. Be sure to put check in <code>Enable Timers</code>, <code>Arm</code>, and <code>Repeat</code> .</p>
<p><img src="images/sprinklerTimer1.png" alt="Sunrise Starting Timer"></p>
<p>Setup the sunset starting timer the same.</p>
<p>Now to stop the watering. Setup Timer 3 for like this.</p>
<p><img src="images/sprinklerTimer3.png" alt="Sunrise Stopping Timer"></p>
<p>A offset is used to stop the watering from occurring because it's sunrise/sunset + 15 minutes. The documentation states the following:</p>
<blockquote>
<p>When Mode 1 or Mode 2 is used, Latitude and Longitude become available. In that case the Time value is always used as an offset so make sure to set it to 00:00 if no offset is wanted</p>
</blockquote>
<p>Using the Tasmota Web Console Command line, type in the timers to verify:<br>
<code>Timer1</code> , <code>Timer2</code> , <code>Timer3</code> and <code>Timer4</code> .</p>
<p>It should look like this:</p>
<pre><code>14:35:44 CMD: Timer1
14:35:44 MQT: stat/tasmota_6A24DE/RESULT = {&quot;Timer1&quot;:{&quot;Arm&quot;:1,&quot;Mode&quot;:1,&quot;Time&quot;:&quot;00:00&quot;,&quot;Window&quot;:0,&quot;Days&quot;:&quot;1111111&quot;,&quot;Repeat&quot;:1,&quot;Output&quot;:1,&quot;Action&quot;:1}}
14:35:47 CMD: Timer2
14:35:47 MQT: stat/tasmota_6A24DE/RESULT = {&quot;Timer2&quot;:{&quot;Arm&quot;:1,&quot;Mode&quot;:2,&quot;Time&quot;:&quot;00:00&quot;,&quot;Window&quot;:0,&quot;Days&quot;:&quot;1111111&quot;,&quot;Repeat&quot;:1,&quot;Output&quot;:1,&quot;Action&quot;:1}}
14:35:50 CMD: Timer3
14:35:50 MQT: stat/tasmota_6A24DE/RESULT = {&quot;Timer3&quot;:{&quot;Arm&quot;:1,&quot;Mode&quot;:1,&quot;Time&quot;:&quot;00:20&quot;,&quot;Window&quot;:0,&quot;Days&quot;:&quot;1111111&quot;,&quot;Repeat&quot;:1,&quot;Output&quot;:1,&quot;Action&quot;:0}}
14:35:52 CMD: Timer4
14:35:52 MQT: stat/tasmota_6A24DE/RESULT = {&quot;Timer4&quot;:{&quot;Arm&quot;:1,&quot;Mode&quot;:2,&quot;Time&quot;:&quot;00:20&quot;,&quot;Window&quot;:0,&quot;Days&quot;:&quot;1111111&quot;,&quot;Repeat&quot;:1,&quot;Output&quot;:1,&quot;Action&quot;:0}}
</code></pre>
<h2>Extending to other Platforms (Optional)</h2>
<p>Using a simple flow in NodeRed, I've added support for a UI and Alexa control with tracking usage via Graphana. Using the MQTT message <code>tele/tasmota_YOURDEVICE/SENSOR</code> , the data is formatted and sent to a <a href="https://grafana.com/tutorials/install-grafana-on-raspberry-pi/#3">local Graphana instance</a> on a Raspberry PI.</p>
<p><img src="images/sprinklerNodeRedWithAlexa.png" alt="Nodered with Alexa support"></p>
<p><img src="images/sprinklerNodeRedUI.png" alt="Nodered with Alexa support"></p>
<p>Simple tracking the ON/OFF state of tasmota MQTT messages</p>
<p><img src="images/sprinklerGraphana.png" alt="Nodered with Alexa support"></p>
<h3>Setup Rules (Optional)</h3>
<p>Here are two more timers (or rules) wanted:</p>
<ul>
<li>WIP - before sunrise, check the temperature. if it's too cold, send a MQTT message and disable start timers</li>
<li>WIP - before sunrise, check the humidity, if it's raining then disable timer.</li>
</ul>
<!-- ## UPDATE 

I took on the challenge of creating PCB with a Esp8266 microcontroller, screen, and a BME280 (temperature, humidity, and pressure). -->
<h2>Resources</h2>
<ul>
<li>https://tasmota.github.io/docs/Commands/</li>
<li>https://tasmota.github.io/docs/Timers/</li>
</ul>

    </section>
  </article>
</main>
<aside class="postAside">
  <b>Latest Posts</b>
  <ul class="unstyledUl">
    <li>
      <a class="read-more" href="automate-sprinkler-with-tasmota">Sprinklers, like programming on a VCR but worst!</a>
    </li>
    <li>
      <a class="read-more" href="power-switch-monitor">Power Switch Monitor with an Arduino device</a>
    </li>
    <li>
      <a class="read-more" href="3dprinter-duplicator-i3-upgrade">Duplicator i3 3d printer upgrade</a>
    </li>
    <li>
      <a class="read-more" href="json-to-s3-with-google-recaptcha">Save JSON Objects to AWS S3 with Google Recaptcha</a>
    </li>
    <li>
      <a class="read-more" href="research-bluetooth-proximity">Research on Bluetooth Proximity</a>
    </li>
    <li>
      <a class="read-more" href="software-engineering-lessons">Software Engineering Lessons</a>
    </li>
    <li>
      <a class="read-more" href="raspberry-pi-bluetooth-proximity">Raspberry Pi ‚Äì Bluetooth Proximity</a>
    </li>
    <li>
      <a class="read-more" href="yet-another-garage-door-opener">Yet Another Garage Door Opener</a>
    </li>
    <li>
      <a class="read-more" href="asp-net-xss-protection">ASP.NET XSS protection</a>
    </li>
  </ul>
  <br />
  <b>Other</b><br />
  See something inaccurate or need more detail? Submit a <a href="https://github.com/skittleson/DoCodeThatMatters">Pull
    Request</a> to help me out!
</aside>

<script async src="js/site.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-93963699-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-93963699-1');
</script>
</body>

</html>